<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Cadence</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- FIX: Corrected 'xintegrity' to 'integrity' for proper security checks. -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" xintegrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body { font-family: 'Inter', sans-serif; }
        .main-container { background-color: #F4F7FE; }
        .post-card .actions, .task-item .actions { opacity: 0; transition: opacity 0.3s ease-in-out; }
        .post-card:hover .actions, .task-item:hover .actions { opacity: 1; }
        .calendar-day { cursor: pointer; transition: background-color 0.2s; }
        .calendar-day.selected { background-color: #4f46e5 !important; color: white !important; border-radius: 9999px; }
        .platform-nav a.active { color: #1f2937; font-weight: 600; border-bottom: 2px solid #4f46e5; padding-bottom: 4px; }
        #sidebar-nav a.active { background-color: #EEF2FF; color: #4338CA; }
    </style>
</head>
<body class="main-container">
    <!-- Login View -->
    <div id="login-view" class="flex items-center justify-center min-h-screen">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md">
            <div class="text-center">
                <h1 class="text-3xl font-bold text-gray-900">Content Cadence</h1>
                <p class="mt-2 text-sm text-gray-600">Sign in to manage your content schedule</p>
            </div>
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="login-email" class="text-sm font-medium text-gray-700 sr-only">Email address</label>
                    <input id="login-email" name="email" type="email" autocomplete="email" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="Email address">
                </div>
                <div>
                    <label for="login-password" class="text-sm font-medium text-gray-700 sr-only">Password</label>
                    <input id="login-password" name="password" type="password" autocomplete="current-password" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="Password">
                </div>
                <div>
                    <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Sign in
                    </button>
                </div>
            </form>
             <p id="auth-error" class="text-sm text-center text-red-600"></p>
            <p class="text-sm text-center text-gray-600">
                Don't have an account?
                <a href="#" id="show-signup" class="font-medium text-indigo-600 hover:text-indigo-500">
                    Sign up
                </a>
            </p>
        </div>
    </div>
    
     <!-- Signup View -->
    <div id="signup-view" class="hidden flex items-center justify-center min-h-screen">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md">
            <div class="text-center">
                 <h1 class="text-3xl font-bold text-gray-900">Create Account</h1>
                 <p class="mt-2 text-sm text-gray-600">Get started with Content Cadence</p>
            </div>
            <form id="signup-form" class="space-y-6">
                <div>
                    <label for="signup-email" class="text-sm font-medium text-gray-700 sr-only">Email address</label>
                    <input id="signup-email" name="email" type="email" autocomplete="email" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="Email address">
                </div>
                <div>
                    <label for="signup-password" class="text-sm font-medium text-gray-700 sr-only">Password</label>
                    <input id="signup-password" name="password" type="password" autocomplete="new-password" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="Password (min. 6 characters)">
                </div>
                <div>
                    <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Create Account
                    </button>
                </div>
            </form>
             <p id="signup-error" class="text-sm text-center text-red-600"></p>
            <p class="text-sm text-center text-gray-600">
                Already have an account?
                <a href="#" id="show-login" class="font-medium text-indigo-600 hover:text-indigo-500">
                    Sign in
                </a>
            </p>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="hidden flex h-screen">
        <!-- Sidebar -->
        <aside class="w-20 bg-white flex flex-col items-center py-6 space-y-8 flex-shrink-0">
            <div class="text-2xl font-bold text-indigo-600">CC</div>
            <nav id="sidebar-nav" class="flex flex-col items-center space-y-6">
                <a href="#" data-view="scheduler" class="group relative p-3 rounded-lg active">
                    <i class="fas fa-calendar-alt"></i>
                    <span class="absolute left-full ml-4 top-1/2 -translate-y-1/2 w-auto min-w-max p-2 bg-gray-800 text-white text-xs rounded-md shadow-lg opacity-0 group-hover:opacity-100 transition-opacity z-10">Scheduler</span>
                </a>
                <a href="#" data-view="tasks" class="group relative text-gray-400 hover:text-indigo-600 p-3 rounded-lg">
                    <i class="fas fa-check-square"></i>
                    <span class="absolute left-full ml-4 top-1/2 -translate-y-1/2 w-auto min-w-max p-2 bg-gray-800 text-white text-xs rounded-md shadow-lg opacity-0 group-hover:opacity-100 transition-opacity z-10">Tasks</span>
                </a>
                <a href="#" data-view="templates" class="group relative text-gray-400 hover:text-indigo-600 p-3 rounded-lg">
                    <i class="fas fa-file-alt"></i>
                    <span class="absolute left-full ml-4 top-1/2 -translate-y-1/2 w-auto min-w-max p-2 bg-gray-800 text-white text-xs rounded-md shadow-lg opacity-0 group-hover:opacity-100 transition-opacity z-10">Templates</span>
                </a>
                <a href="#" id="collapse-btn" class="group relative text-gray-400 hover:text-indigo-600 p-3 rounded-lg">
                    <i id="collapse-icon" class="fas fa-chevron-left"></i>
                     <span class="absolute left-full ml-4 top-1/2 -translate-y-1/2 w-auto min-w-max p-2 bg-gray-800 text-white text-xs rounded-md shadow-lg opacity-0 group-hover:opacity-100 transition-opacity z-10">Collapse</span>
                </a>
                <a href="#" data-view="settings" class="group relative text-gray-400 hover:text-indigo-600 p-3 rounded-lg">
                    <i class="fas fa-cog"></i>
                     <span class="absolute left-full ml-4 top-1/2 -translate-y-1/2 w-auto min-w-max p-2 bg-gray-800 text-white text-xs rounded-md shadow-lg opacity-0 group-hover:opacity-100 transition-opacity z-10">Settings</span>
                </a>
            </nav>
            <div class="mt-auto">
                <a href="#" id="logout-btn" class="group relative text-gray-400 hover:text-indigo-600 p-3 rounded-lg">
                    <i class="fas fa-sign-out-alt"></i>
                    <span class="absolute left-full ml-4 top-1/2 -translate-y-1/2 w-auto min-w-max p-2 bg-gray-800 text-white text-xs rounded-md shadow-lg opacity-0 group-hover:opacity-100 transition-opacity z-10">Logout</span>
                </a>
            </div>
        </aside>

        <!-- Left Panel -->
        <div id="left-panel" class="bg-white border-r border-gray-200 flex flex-col transition-all duration-300 ease-in-out w-80 p-6 overflow-y-auto">
            <div id="left-panel-content" class="transition-opacity duration-300 ease-in-out">
                <div class="flex items-center space-x-3 mb-8">
                    <img src="https://placehold.co/40x40/E0E7FF/4F46E5?text=AV" alt="User Avatar" class="rounded-full">
                    <div>
                        <p class="text-sm text-gray-500">Hello ðŸ‘‹</p>
                        <p id="user-name" class="font-semibold text-gray-800">Anselme Motcho</p>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-indigo-100 text-indigo-800 p-4 rounded-lg"><p id="stat-completed" class="text-3xl font-bold">0</p><p class="text-sm">Completed</p></div>
                    <div class="bg-gray-100 text-gray-800 p-4 rounded-lg"><p id="stat-total" class="text-3xl font-bold">0</p><p class="text-sm">Total Post</p></div>
                    <div class="bg-yellow-100 text-yellow-800 p-4 rounded-lg"><p id="stat-in-progress" class="text-3xl font-bold">0</p><p class="text-sm">In progress</p></div>
                    <div class="bg-red-100 text-red-800 p-4 rounded-lg"><p id="stat-out-of-scheduled" class="text-3xl font-bold">0</p><p class="text-sm">Out of scheduled</p></div>
                </div>

                <!-- Calendar -->
                <div class="mb-6">
                     <div class="flex justify-between items-center mb-4">
                         <h3 id="calendar-month-year" class="font-semibold text-gray-800"></h3>
                         <div class="flex space-x-2"><button id="prev-month" class="text-gray-500 hover:text-gray-800">&lt;</button><button id="next-month" class="text-gray-500 hover:text-gray-800">&gt;</button></div>
                     </div>
                     <div class="grid grid-cols-7 text-center text-sm text-gray-500"><div>Mo</div><div>Tu</div><div>We</div><div>Th</div><div>Fr</div><div>Sa</div><div>Su</div></div>
                     <div id="calendar-grid" class="grid grid-cols-7 text-center text-sm mt-2"></div>
                </div>

                <!-- Post Stats -->
                <div class="mt-auto">
                    <div class="flex justify-between items-center mb-4"><h3 class="font-semibold text-gray-800">Post Stats</h3><p id="stats-month" class="text-sm text-gray-500"></p></div>
                    <div><canvas id="postStatsChart"></canvas></div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <main class="flex-1 p-8 overflow-y-auto">
            <div id="main-app-content">
                <!-- SCHEDULER VIEW -->
                <div id="scheduler-view">
                    <header class="flex justify-between items-center mb-8">
                        <div class="platform-nav flex items-center space-x-6">
                            <a href="#" data-platform="All" class="active">All</a>
                            <a href="#" data-platform="instagram" class="text-gray-500 hover:text-gray-800">Instagram</a>
                            <a href="#" data-platform="linkedin" class="text-gray-500 hover:text-gray-800">LinkedIn</a>
                            <a href="#" data-platform="dribbble" class="text-gray-500 hover:text-gray-800">Dribbble</a>
                            <a href="#" data-platform="facebook" class="text-gray-500 hover:text-gray-800">Facebook</a>
                            <button id="add-post-btn" class="text-indigo-600 font-semibold">+ Add</button>
                        </div>
                        <div class="flex items-center space-x-4"><button class="text-gray-500 hover:text-gray-800"><i class="fas fa-search"></i></button><button class="text-gray-500 hover:text-gray-800"><i class="fas fa-bell"></i></button><img src="https://placehold.co/32x32/E0E7FF/4F46E5?text=AV" alt="User Avatar" class="rounded-full"></div>
                    </header>
                    <div>
                        <div class="flex justify-between items-center mb-6"><h2 id="main-view-title" class="text-2xl font-bold text-gray-800">Scheduled Post</h2><div id="main-view-controls" class="flex items-center space-x-4"><button id="clear-filter-btn" class="hidden px-3 py-1 bg-red-100 text-red-700 text-sm rounded-lg">Clear Filter</button></div></div>
                        <div id="posts-grid" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-6"></div>
                    </div>
                </div>

                <!-- TASKS VIEW -->
                <div id="tasks-view" class="hidden">
                    <header class="flex justify-between items-center mb-8"><h2 class="text-2xl font-bold text-gray-800">My Tasks</h2><div class="flex items-center space-x-4"><button class="text-gray-500 hover:text-gray-800"><i class="fas fa-search"></i></button><img src="https://placehold.co/32x32/E0E7FF/4F46E5?text=AV" alt="User Avatar" class="rounded-full"></div></header>
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <form id="add-task-form" class="flex items-center mb-6"><input type="text" id="new-task-input" placeholder="Add a new task..." class="w-full border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 mr-4" required><button type="submit" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 whitespace-nowrap">Add Task</button></form>
                        <div id="task-list" class="space-y-4"></div>
                    </div>
                </div>

                 <!-- SETTINGS VIEW -->
                <div id="settings-view" class="hidden">
                    <header class="flex justify-between items-center mb-8">
                        <h2 class="text-2xl font-bold text-gray-800">Settings</h2>
                    </header>
                    <div class="space-y-12">
                        <!-- Account Information -->
                        <div class="bg-white p-6 rounded-lg shadow-sm">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Account Information</h3>
                            <div class="space-y-4">
                                <div>
                                    <label for="settings-email" class="block text-sm font-medium text-gray-700">Email Address</label>
                                    <input type="email" id="settings-email" class="mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm sm:text-sm" disabled>
                                </div>
                                <form id="change-password-form" class="space-y-4">
                                    <div>
                                        <label for="current-password" class="block text-sm font-medium text-gray-700">Current Password</label>
                                        <input type="password" id="current-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Enter your current password">
                                    </div>
                                    <div>
                                        <label for="new-password" class="block text-sm font-medium text-gray-700">New Password</label>
                                        <input type="password" id="new-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Enter a new password">
                                    </div>
                                    <div class="flex justify-end">
                                        <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 text-sm">Change Password</button>
                                    </div>
                                     <p id="password-feedback" class="text-sm"></p>
                                </form>
                            </div>
                        </div>

                        <!-- Preferences -->
                        <div class="bg-white p-6 rounded-lg shadow-sm">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Preferences</h3>
                            <div class="space-y-4">
                                <div>
                                    <label for="default-platform" class="block text-sm font-medium text-gray-700">Default Platform for New Posts</label>
                                    <select id="default-platform" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                        <option value="none">None</option>
                                        <option value="linkedin">LinkedIn</option>
                                        <option value="instagram">Instagram</option>
                                        <option value="dribbble">Dribbble</option>
                                    </select>
                                </div>
                                <div class="flex justify-end">
                                     <button id="save-preferences-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 text-sm">Save Preferences</button>
                                </div>
                                 <p id="preferences-feedback" class="text-sm text-green-600"></p>
                            </div>
                        </div>

                        <!-- Data Management -->
                        <div class="bg-white p-6 rounded-lg shadow-sm">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Data Management</h3>
                            <div class="flex justify-start">
                                <button id="export-csv-btn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">
                                    <i class="fas fa-file-csv mr-2"></i>Export All Posts to CSV
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Add/Edit Post Modal -->
    <div id="post-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 w-full max-w-md">
            <h2 id="modal-title" class="text-2xl font-bold mb-6">Add New Post</h2>
            <form id="post-form">
                <input type="hidden" id="post-id">
                <div class="mb-4"><label for="post-title" class="block text-sm font-medium text-gray-700 mb-1">Title</label><input type="text" id="post-title" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" required></div>
                <div class="mb-4"><label for="post-image" class="block text-sm font-medium text-gray-700 mb-1">Image URL</label><input type="url" id="post-image" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="https://placehold.co/..." required></div>
                <div class="mb-4"><label for="post-date" class="block text-sm font-medium text-gray-700 mb-1">Date</label><input type="date" id="post-date" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" required></div>
                <div class="mb-4"><label for="post-time" class="block text-sm font-medium text-gray-700 mb-1">Time</label><input type="time" id="post-time" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" required></div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Platform</label>
                    <div class="flex space-x-4">
                        <label class="flex items-center"><input type="radio" name="platform" value="linkedin" class="mr-2"> LinkedIn</label>
                        <label class="flex items-center"><input type="radio" name="platform" value="instagram" class="mr-2"> Instagram</label>
                        <label class="flex items-center"><input type="radio" name="platform" value="dribbble" class="mr-2"> Dribbble</label>
                    </div>
                </div>
                <div class="flex justify-end space-x-4"><button type="button" id="cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancel</button><button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Save Post</button></div>
            </form>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, EmailAuthProvider, reauthenticateWithCredential, updatePassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const userFirebaseConfig = {
            apiKey: "AIzaSyBctJBNfRI_WHzBTQb02rCuxTu3bzjzCgE",
            authDomain: "amplifyio-c5ad7.firebaseapp.com",
            projectId: "amplifyio-c5ad7",
            storageBucket: "amplifyio-c5ad7.firebasestorage.app",
            messagingSenderId: "205704225259",
            appId: "1:205704225259:web:43673a93e0aeb6e280f9ae",
            measurementId: "G-7CZE0PL12M"
        };
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : userFirebaseConfig;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const App = {
            state: { userId: null, posts: [], tasks: [], settings: {}, currentDate: new Date(), selectedDate: null, selectedPlatform: 'All', isInitialized: false, chart: null, isPanelCollapsed: false },
            elements: {},
            utils: { 
                formatDate: (date) => date.toISOString().split('T')[0],
                showFeedback(element, message, isError = false) {
                    element.textContent = message;
                    element.className = `text-sm ${isError ? 'text-red-600' : 'text-green-600'}`;
                    setTimeout(() => element.textContent = '', 3000);
                }
            },
            renderers: {
                updateStats() {
                    if (!App.elements.statCompleted) return;
                    const { posts } = App.state;
                    const now = new Date();
                    App.elements.statCompleted.textContent = posts.filter(p => p.completed).length;
                    App.elements.statTotal.textContent = posts.length;
                    App.elements.statInProgress.textContent = posts.filter(p => !p.completed && new Date(`${p.date}T${p.time}`) > now).length;
                    App.elements.statOutOfScheduled.textContent = posts.filter(p => !p.completed && new Date(`${p.date}T${p.time}`) < now).length;
                },
                renderTasks() {
                    const { tasks } = App.state;
                    App.elements.taskList.innerHTML = '';
                    if (tasks.length === 0) {
                        App.elements.taskList.innerHTML = `<p class="text-gray-500 text-center">No tasks yet. Add one above!</p>`;
                        return;
                    }
                    tasks.sort((a, b) => (a.createdAt || 0) - (b.createdAt || 0)).forEach(task => {
                        const taskItem = document.createElement('div');
                        taskItem.className = 'task-item flex items-center justify-between p-3 border-b border-gray-200';
                        taskItem.dataset.id = task.id;
                        taskItem.innerHTML = `<div class="flex items-center"><input type="checkbox" class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 mr-4 toggle-task" ${task.completed ? 'checked' : ''}><span class="task-text ${task.completed ? 'line-through text-gray-400' : 'text-gray-800'}">${task.text}</span></div><div class="actions"><button class="delete-task text-gray-400 hover:text-red-600"><i class="fas fa-trash-alt"></i></button></div>`;
                        App.elements.taskList.appendChild(taskItem);
                    });
                },
                createPostCard(post) {
                    const postCard = document.createElement('div');
                    postCard.className = 'bg-white p-4 rounded-lg shadow-sm relative post-card';
                    postCard.dataset.id = post.id;
                    const platformIcons = {
                        linkedin: `<span class="w-6 h-6 bg-blue-600 rounded-full text-white flex items-center justify-center text-sm"><i class="fab fa-linkedin-in"></i></span>`,
                        instagram: `<span class="w-6 h-6 bg-gradient-to-tr from-yellow-400 via-red-500 to-purple-500 rounded-full text-white flex items-center justify-center text-sm"><i class="fab fa-instagram"></i></span>`,
                        dribbble: `<span class="w-6 h-6 bg-pink-500 rounded-full text-white flex items-center justify-center text-sm"><i class="fab fa-dribbble"></i></span>`
                    };
                    postCard.innerHTML = `<div class="actions absolute top-2 right-2 flex space-x-2"><button class="edit-btn text-gray-500 hover:text-indigo-600"><i class="fas fa-pencil-alt fa-xs"></i></button><button class="delete-btn text-gray-500 hover:text-red-600"><i class="fas fa-trash-alt fa-xs"></i></button></div><img src="${post.image}" alt="${post.title}" class="rounded-lg mb-3 w-full h-24 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/200x100/cccccc/ffffff?text=Error';"><h4 class="font-semibold mb-1 truncate">${post.title}</h4><p class="text-sm text-gray-500 mb-2"><i class="far fa-clock mr-1"></i> ${post.time}</p><div class="flex items-center space-x-2">${platformIcons[post.platform] || ''}</div>`;
                    return postCard;
                },
                renderPosts() {
                    let filteredPosts = [...App.state.posts];
                    if (App.state.selectedPlatform !== 'All') { filteredPosts = filteredPosts.filter(p => p.platform === App.state.selectedPlatform); }
                    const grid = App.elements.postsGrid;
                    grid.innerHTML = '';
                    grid.className = 'grid gap-6';
                    if (App.state.selectedDate) {
                        filteredPosts = filteredPosts.filter(p => p.date === App.state.selectedDate);
                        grid.classList.add('grid-cols-1', 'md:grid-cols-2', 'lg:grid-cols-3');
                        App.elements.mainViewTitle.textContent = `Posts for ${new Date(App.state.selectedDate + 'T00:00:00').toLocaleDateString('en-US', { month: 'long', day: 'numeric' })}`;
                        App.elements.clearFilterBtn.classList.remove('hidden');
                        if (filteredPosts.length > 0) { filteredPosts.forEach(post => grid.appendChild(this.createPostCard(post))); } 
                        else { grid.innerHTML = `<div class="text-center text-gray-500 col-span-full">No posts scheduled for this day.</div>`; }
                    } else {
                        grid.classList.add('grid-cols-1', 'md:grid-cols-3', 'lg:grid-cols-5');
                        App.elements.mainViewTitle.textContent = 'Scheduled Post';
                        App.elements.clearFilterBtn.classList.add('hidden');
                        const daysOfWeek = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
                        daysOfWeek.forEach((day, index) => {
                            const dayColumn = document.createElement('div');
                            dayColumn.className = 'space-y-4';
                            const postsForDay = filteredPosts.filter(p => (new Date(p.date + 'T00:00:00').getUTCDay() || 7) === index + 1);
                            
                            const dayHeader = document.createElement('div');
                            dayHeader.className = 'text-center';
                            dayHeader.innerHTML = `<p class="font-semibold">${day}</p><p class="text-sm text-gray-500">${postsForDay.length} Post${postsForDay.length !== 1 ? 's' : ''}</p>`;
                            dayColumn.appendChild(dayHeader);

                            if (postsForDay.length > 0) { 
                                postsForDay.forEach(post => dayColumn.appendChild(this.createPostCard(post)));
                            } else {
                                const noPostsEl = document.createElement('div');
                                noPostsEl.className = 'text-center text-sm text-gray-400 p-4 border-2 border-dashed rounded-lg';
                                noPostsEl.textContent = 'No posts';
                                dayColumn.appendChild(noPostsEl);
                            }
                            grid.appendChild(dayColumn);
                        });
                    }
                },
                renderCalendar() {
                    const { calendarGrid, calendarMonthYear, statsMonth } = App.elements;
                    const { currentDate, selectedDate } = App.state;
                    calendarGrid.innerHTML = '';
                    const year = currentDate.getFullYear(); const month = currentDate.getMonth();
                    const monthName = currentDate.toLocaleString('default', { month: 'long' });
                    calendarMonthYear.textContent = `${monthName} ${year}`;
                    statsMonth.textContent = monthName;

                    const firstDayOfMonth = new Date(year, month, 1).getDay();
                    const daysInMonth = new Date(year, month + 1, 0).getDate();
                    const startOffset = (firstDayOfMonth === 0) ? 6 : firstDayOfMonth - 1;
                    
                    for (let i = 0; i < startOffset; i++) { calendarGrid.appendChild(document.createElement('div')); }
                    
                    for (let day = 1; day <= daysInMonth; day++) {
                        const dayEl = document.createElement('div');
                        dayEl.className = 'py-2 calendar-day';
                        dayEl.textContent = day;
                        const thisDate = App.utils.formatDate(new Date(year, month, day));
                        dayEl.dataset.date = thisDate;
                        if (thisDate === selectedDate) { dayEl.classList.add('selected'); }
                        calendarGrid.appendChild(dayEl);
                    }
                },
                renderPostStatsChart() {
                    if (!App.state.chart) return;

                    const { currentDate, posts } = App.state;
                    const year = currentDate.getFullYear();
                    const month = currentDate.getMonth();

                    const postsThisMonth = posts.filter(post => {
                        const postDate = new Date(post.date + 'T00:00:00');
                        return postDate.getFullYear() === year && postDate.getMonth() === month;
                    });
                    
                    const weeklyCounts = [0, 0, 0, 0, 0];
                    postsThisMonth.forEach(post => {
                        const dayOfMonth = new Date(post.date + 'T00:00:00').getDate();
                        const weekOfMonth = Math.floor((dayOfMonth - 1) / 7);
                        if (weekOfMonth < 5) {
                            weeklyCounts[weekOfMonth]++;
                        }
                    });

                    App.state.chart.data.labels = ['Week 1', 'Week 2', 'Week 3', 'Week 4', 'Week 5'];
                    App.state.chart.data.datasets[0].data = weeklyCounts;
                    App.state.chart.update();
                }
            },
            handlers: {
                handleCollapseToggle(e) {
                    e.preventDefault();
                    App.state.isPanelCollapsed = !App.state.isPanelCollapsed;
                    
                    const { leftPanel, leftPanelContent, collapseIcon } = App.elements;
                    
                    if (App.state.isPanelCollapsed) {
                        leftPanel.classList.replace('w-80', 'w-0');
                        leftPanel.classList.replace('p-6', 'p-0');
                        leftPanelContent.classList.add('opacity-0');
                        collapseIcon.classList.replace('fa-chevron-left', 'fa-chevron-right');
                    } else {
                        leftPanel.classList.replace('w-0', 'w-80');
                        leftPanel.classList.replace('p-0', 'p-6');
                        leftPanelContent.classList.remove('opacity-0');
                        collapseIcon.classList.replace('fa-chevron-right', 'fa-chevron-left');
                    }
                },
                handleViewSwitch(e) {
                    e.preventDefault();
                    const link = e.target.closest('a');
                    if (!link || !link.dataset.view) return;
                    const view = link.dataset.view;
                    
                    App.elements.sidebarNav.querySelectorAll('a').forEach(a => {
                        if (a.dataset.view) a.classList.remove('active');
                    });
                    link.classList.add('active');
                    
                    const views = ['schedulerView', 'tasksView', 'settingsView', 'templatesView'];
                    views.forEach(v => App.elements[v] && App.elements[v].classList.add('hidden'));

                    const viewEl = App.elements[view + 'View'];
                    if(viewEl) viewEl.classList.remove('hidden');
                },
                async handleAddTask(e) {
                    e.preventDefault(); 
                    const text = App.elements.newTaskInput.value.trim(); 
                    if (text) { 
                        await window.firestore.createTask(App.state.userId, { text, completed: false, createdAt: Date.now() }); 
                        App.elements.newTaskInput.value = ''; 
                    } 
                },
                async handleTaskListClick(e) {
                    const taskItem = e.target.closest('.task-item');
                    if (!taskItem) return;
                    const taskId = taskItem.dataset.id;
                    const task = App.state.tasks.find(t => t.id === taskId);
                    if (!task) return;
                    if (e.target.classList.contains('toggle-task')) {
                        await window.firestore.updateTask(App.state.userId, taskId, { ...task, completed: !task.completed });
                    }
                    if (e.target.closest('.delete-task')) {
                        await window.firestore.deleteTask(App.state.userId, taskId);
                    }
                },
                openModal(mode, post = null) {
                    App.elements.postForm.reset();
                    if(App.state.settings.defaultPlatform && App.state.settings.defaultPlatform !== 'none') {
                        App.elements.postForm.querySelector(`input[name="platform"][value="${App.state.settings.defaultPlatform}"]`).checked = true;
                    }

                    if (mode === 'edit' && post) {
                        App.elements.modalTitle.textContent = 'Edit Post';
                        App.elements.postId.value = post.id;
                        App.elements.postTitle.value = post.title;
                        App.elements.postImage.value = post.image;
                        App.elements.postDate.value = post.date;
                        App.elements.postTime.value = post.time;
                        if(post.platform) App.elements.postForm.querySelector(`input[name="platform"][value="${post.platform}"]`).checked = true;
                    } else {
                        App.elements.modalTitle.textContent = 'Add New Post';
                        App.elements.postId.value = '';
                    }
                    App.elements.postModal.classList.remove('hidden');
                },
                closeModal() { App.elements.postModal.classList.add('hidden'); },
                async handleFormSubmit(e) {
                    e.preventDefault();
                    const id = App.elements.postId.value;
                    const platformInput = App.elements.postForm.querySelector('input[name="platform"]:checked');
                    const postData = {
                        title: App.elements.postTitle.value,
                        image: App.elements.postImage.value,
                        date: App.elements.postDate.value,
                        time: App.elements.postTime.value,
                        platform: platformInput ? platformInput.value : 'instagram',
                        completed: false
                    };
                    if (id) {
                        const existingPost = App.state.posts.find(p => p.id === id);
                        await window.firestore.updatePost(App.state.userId, id, {...existingPost, ...postData});
                    } else {
                        await window.firestore.createPost(App.state.userId, postData);
                    }
                    this.closeModal();
                },
                async handleGridClick(e) {
                    const postCard = e.target.closest('.post-card');
                    if (!postCard) return;
                    const postId = postCard.dataset.id;
                    const post = App.state.posts.find(p => p.id === postId);
                    if (!post) return;

                    if (e.target.closest('.edit-btn')) {
                        this.openModal('edit', post);
                    }
                    if (e.target.closest('.delete-btn')) {
                         await window.firestore.deletePost(App.state.userId, postId);
                    }
                },
                handleCalendarClick(e) {
                    const dayEl = e.target.closest('.calendar-day');
                    if (dayEl && dayEl.dataset.date) {
                        if (App.state.selectedDate === dayEl.dataset.date) {
                             App.state.selectedDate = null;
                        } else {
                            App.state.selectedDate = dayEl.dataset.date;
                        }
                        App.renderers.renderCalendar();
                        App.renderers.renderPosts();
                    }
                },
                handlePlatformNavClick(e) {
                     e.preventDefault(); 
                     const link = e.target.closest('a'); 
                     if (link && link.dataset.platform) { 
                         App.state.selectedPlatform = link.dataset.platform; 
                         App.elements.platformNav.querySelectorAll('a').forEach(a => a.classList.remove('active'));
                         link.classList.add('active'); 
                         App.renderers.renderPosts(); 
                     } 
                },
                handleClearFilter() {
                    App.state.selectedDate = null;
                    App.renderers.renderCalendar();
                    App.renderers.renderPosts();
                },
                handleCalendarNav(direction) {
                    App.state.currentDate.setMonth(App.state.currentDate.getMonth() + direction);
                    App.renderers.renderCalendar();
                    App.renderers.renderPostStatsChart();
                },
                async handleSavePreferences(e) {
                    e.preventDefault();
                    const defaultPlatform = App.elements.defaultPlatform.value;
                    await window.firestore.updateUserSettings(App.state.userId, { defaultPlatform });
                    App.utils.showFeedback(App.elements.preferencesFeedback, "Preferences saved successfully!");
                },
                async handleChangePassword(e) {
                    e.preventDefault();
                    const { currentPassword, newPassword, passwordFeedback } = App.elements;
                    const user = auth.currentUser;
                    if (!user) return;

                    const credential = EmailAuthProvider.credential(user.email, currentPassword.value);
                    try {
                        await reauthenticateWithCredential(user, credential);
                        await updatePassword(user, newPassword.value);
                        App.utils.showFeedback(passwordFeedback, "Password updated successfully!");
                        e.target.reset();
                    } catch (error) {
                         App.utils.showFeedback(passwordFeedback, `Error: ${error.message}`, true);
                    }
                },
                handleExportCSV(e) {
                    e.preventDefault();
                    const posts = App.state.posts;
                    if (posts.length === 0) {
                        alert("No posts to export.");
                        return;
                    }

                    const headers = ["ID", "Title", "Date", "Time", "Platform", "Image URL", "Completed"];
                    const csvRows = [headers.join(",")];

                    const escapeCsv = (str) => `"${(str || '').replace(/"/g, '""')}"`;

                    posts.forEach(post => {
                        const row = [
                            post.id,
                            escapeCsv(post.title),
                            post.date,
                            post.time,
                            post.platform,
                            escapeCsv(post.image),
                            post.completed
                        ];
                        csvRows.push(row.join(","));
                    });

                    const blob = new Blob([csvRows.join("\n")], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement("a");
                    const url = URL.createObjectURL(blob);
                    link.setAttribute("href", url);
                    link.setAttribute("download", "content_cadence_posts.csv");
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            },
            setupPostStatsChart() {
                const ctx = document.getElementById('postStatsChart').getContext('2d');
                App.state.chart = new Chart(ctx, { 
                    type: 'line', 
                    data: { 
                        labels: [], 
                        datasets: [{ 
                            label: 'Posts', 
                            data: [], 
                            backgroundColor: 'rgba(79, 70, 229, 0.1)', 
                            borderColor: 'rgba(79, 70, 229, 1)', 
                            borderWidth: 2, 
                            tension: 0.4, 
                            fill: true 
                        }] 
                    }, 
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        scales: { 
                            y: { beginAtZero: true, display: false }, 
                            x: { grid: { display: false } } 
                        }, 
                        plugins: { legend: { display: false } } 
                    } 
                });
            },
            init(userId) {
                if (this.state.isInitialized) return;
                this.state.isInitialized = true;
                this.state.userId = userId;

                const elementMappings = {
                    'appContainer': 'app-container', 'loginView': 'login-view', 'signupView': 'signup-view', 
                    'loginForm': 'login-form', 'signupForm': 'signup-form', 'showSignup': 'show-signup', 
                    'showLogin': 'show-login', 'logoutBtn': 'logout-btn', 'authError': 'auth-error', 
                    'signupError': 'signup-error', 'userName': 'user-name', 'schedulerView': 'scheduler-view', 
                    'tasksView': 'tasks-view', 'sidebarNav': 'sidebar-nav', 'postsGrid': 'posts-grid', 
                    'postModal': 'post-modal', 'modalTitle': 'modal-title', 'addPostBtn': 'add-post-btn', 
                    'cancelBtn': 'cancel-btn', 'postForm': 'post-form', 'postId': 'post-id', 
                    'postTitle': 'post-title', 'postImage': 'post-image', 'postDate': 'post-date', 
                    'postTime': 'post-time', 'calendarGrid': 'calendar-grid', 'calendarMonthYear': 'calendar-month-year', 
                    'prevMonth': 'prev-month', 'nextMonth': 'next-month', 'mainViewTitle': 'main-view-title', 
                    'clearFilterBtn': 'clear-filter-btn', 'taskList': 'task-list', 'addTaskForm': 'add-task-form', 
                    'newTaskInput': 'new-task-input', 'statCompleted': 'stat-completed', 'statTotal': 'stat-total', 
                    'statInProgress': 'stat-in-progress', 'statOutOfScheduled': 'stat-out-of-scheduled', 
                    'statsMonth': 'stats-month', 'leftPanel': 'left-panel', 'collapseBtn': 'collapse-btn', 
                    'collapseIcon': 'collapse-icon', 'leftPanelContent': 'left-panel-content',
                    'settingsView': 'settings-view', 'settingsEmail': 'settings-email', 
                    'changePasswordForm': 'change-password-form', 'currentPassword': 'current-password',
                    'newPassword': 'new-password', 'passwordFeedback': 'password-feedback',
                    'defaultPlatform': 'default-platform', 'savePreferencesBtn': 'save-preferences-btn',
                    'preferencesFeedback': 'preferences-feedback', 'exportCsvBtn': 'export-csv-btn'
                };
                for (const key in elementMappings) {
                    this.elements[key] = document.getElementById(elementMappings[key]);
                }
                this.elements.platformNav = document.querySelector('.platform-nav');
                
                const currentUser = auth.currentUser;
                this.elements.userName.textContent = currentUser.email;
                this.elements.settingsEmail.value = currentUser.email;

                window.firestore.onPostsUpdate(this.state.userId, (snapshot) => { 
                    this.state.posts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); 
                    this.renderers.renderPosts(); 
                    this.renderers.updateStats();
                    this.renderers.renderPostStatsChart();
                });
                window.firestore.onTasksUpdate(this.state.userId, (snapshot) => { this.state.tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); if (this.elements.tasksView && !this.elements.tasksView.classList.contains('hidden')) { this.renderers.renderTasks(); } });
                window.firestore.onUserSettingsUpdate(this.state.userId, (doc) => {
                    if (doc.exists()) {
                        this.state.settings = doc.data();
                        this.elements.defaultPlatform.value = this.state.settings.defaultPlatform || 'none';
                    }
                });

                this.elements.sidebarNav.addEventListener('click', this.handlers.handleViewSwitch.bind(this.handlers));
                this.elements.addPostBtn.addEventListener('click', () => this.handlers.openModal('add'));
                this.elements.cancelBtn.addEventListener('click', this.handlers.closeModal.bind(this.handlers));
                this.elements.postModal.addEventListener('click', (e) => { if (e.target === this.elements.postModal) this.handlers.closeModal(); });
                this.elements.postForm.addEventListener('submit', this.handlers.handleFormSubmit.bind(this.handlers));
                this.elements.postsGrid.addEventListener('click', this.handlers.handleGridClick.bind(this.handlers));
                this.elements.calendarGrid.addEventListener('click', this.handlers.handleCalendarClick.bind(this.handlers));
                this.elements.prevMonth.addEventListener('click', () => this.handlers.handleCalendarNav(-1));
                this.elements.nextMonth.addEventListener('click', () => this.handlers.handleCalendarNav(1));
                this.elements.platformNav.addEventListener('click', this.handlers.handlePlatformNavClick.bind(this.handlers));
                this.elements.clearFilterBtn.addEventListener('click', this.handlers.handleClearFilter.bind(this.handlers));
                this.elements.addTaskForm.addEventListener('submit', this.handlers.handleAddTask.bind(this.handlers));
                this.elements.taskList.addEventListener('click', this.handlers.handleTaskListClick.bind(this.handlers));
                this.elements.logoutBtn.addEventListener('click', () => signOut(auth));
                this.elements.collapseBtn.addEventListener('click', this.handlers.handleCollapseToggle.bind(this.handlers));
                this.elements.savePreferencesBtn.addEventListener('click', this.handlers.handleSavePreferences.bind(this.handlers));
                this.elements.changePasswordForm.addEventListener('submit', this.handlers.handleChangePassword.bind(this.handlers));
                this.elements.exportCsvBtn.addEventListener('click', this.handlers.handleExportCSV.bind(this.handlers));

                this.setupPostStatsChart();
                this.renderers.renderCalendar();
                this.renderers.renderPostStatsChart();
            }
        };

        const loginView = document.getElementById('login-view');
        const signupView = document.getElementById('signup-view');
        const appContainer = document.getElementById('app-container');
        
        onAuthStateChanged(auth, user => {
            if (user) {
                loginView.classList.add('hidden');
                signupView.classList.add('hidden');
                appContainer.classList.remove('hidden');
                appContainer.classList.add('flex');
                App.init(user.uid);
            } else {
                appContainer.classList.add('hidden');
                appContainer.classList.remove('flex');
                loginView.classList.remove('hidden');
                signupView.classList.add('hidden');
                App.state.isInitialized = false; 
            }
        });

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = e.target.email.value;
            const password = e.target.password.value;
            const errorEl = document.getElementById('auth-error');
            try {
                errorEl.textContent = '';
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                errorEl.textContent = error.message;
            }
        });

        document.getElementById('signup-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = e.target.email.value;
            const password = e.target.password.value;
            const errorEl = document.getElementById('signup-error');
            try {
                 errorEl.textContent = '';
                await createUserWithEmailAndPassword(auth, email, password);
            } catch (error) {
                errorEl.textContent = error.message;
            }
        });

        document.getElementById('show-signup').addEventListener('click', (e) => {
            e.preventDefault();
            loginView.classList.add('hidden');
            signupView.classList.remove('hidden');
        });

        document.getElementById('show-login').addEventListener('click', (e) => {
            e.preventDefault();
            signupView.classList.add('hidden');
            loginView.classList.remove('hidden');
        });

        window.firestore = {
            onPostsUpdate: (userId, callback) => onSnapshot(collection(db, 'artifacts', appId, 'users', userId, 'posts'), callback),
            createPost: (userId, postData) => addDoc(collection(db, 'artifacts', appId, 'users',userId, 'posts'), postData),
            updatePost: (userId, postId, postData) => updateDoc(doc(db, 'artifacts', appId, 'users', userId, 'posts', postId), postData),
            deletePost: (userId, postId) => deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'posts', postId)),
            onTasksUpdate: (userId, callback) => onSnapshot(collection(db, 'artifacts', appId, 'users', userId, 'tasks'), callback),
            createTask: (userId, taskData) => addDoc(collection(db, 'artifacts', appId, 'users', userId, 'tasks'), taskData),
            updateTask: (userId, taskId, taskData) => updateDoc(doc(db, 'artifacts', appId, 'users', userId, 'tasks', taskId), taskData),
            deleteTask: (userId, taskId) => deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'tasks', taskId)),
            onUserSettingsUpdate: (userId, callback) => onSnapshot(doc(db, 'artifacts', appId, 'users', userId, 'settings', 'user'), callback),
            updateUserSettings: (userId, settingsData) => setDoc(doc(db, 'artifacts', appId, 'users', userId, 'settings', 'user'), settingsData, { merge: true }),
        };
    </script>
</body>
</html>

